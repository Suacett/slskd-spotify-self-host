{% extends "base.html" %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex justify-between items-start">
        <div>
            <a href="/" class="text-sm text-gray-500 hover:text-gray-300 mb-2 inline-block">← Back to Dashboard</a>
            <h1 class="text-3xl font-bold text-white">{{ track.artist }} - {{ track.title }}</h1>
            <p class="text-gray-400">{{ track.album }}</p>
        </div>

        <div class="flex space-x-3">
            <button onclick="deleteTrack()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">
                Re-Search / Delete
            </button>
        </div>
    </div>

    <!-- MusicBrainz Metadata -->
    {% if track.musicbrainz %}
    <div class="bg-blue-900 bg-opacity-20 border border-blue-800 rounded p-4 flex justify-between items-center">
        <div>
            <h3 class="text-blue-400 font-bold text-sm uppercase">MusicBrainz Verified</h3>
            <div class="text-white text-sm mt-1">
                ISRC: <span class="font-mono">{{ track.musicbrainz.isrc }}</span> |
                Duration: {{ (track.musicbrainz.duration_ms / 1000)|round|int }}s
            </div>
        </div>
        {% if is_duplicate %}
        <div class="bg-red-900 bg-opacity-50 text-red-200 px-3 py-1 rounded text-sm border border-red-700">
            ⚠ Downloaded Duplicate
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- Controls -->
    <div class="flex items-center justify-between bg-gray-800 p-4 rounded">
        <div class="flex items-center space-x-3">
            <span class="text-gray-300 font-medium">Smart Quality Filter</span>
            <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="smart-toggle" class="sr-only peer" {% if track.smart_filter %}checked{% endif
                    %} onchange="toggleSmartFilter()">
                <div
                    class="w-11 h-6 bg-gray-700 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-green-800 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600">
                </div>
            </label>
        </div>
        <div class="text-sm text-gray-400">
            Showing <span id="visible-count">0</span> of {{ results|length }} results
        </div>
    </div>

    <!-- Results Table -->
    <div class="bg-white dark:bg-gray-800 shadow rounded overflow-hidden">
        <table class="min-w-full divide-y divide-gray-700">
            <thead class="bg-gray-50 dark:bg-gray-900">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">File</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Size</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Bitrate
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Score
                    </th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Action
                    </th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-700" id="results-body">
                {% for r in results %}
                <tr class="result-row {% if loop.index > 20 %}hidden{% endif %} hover:bg-gray-700 transition">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-white">
                        <div class="truncate w-64" title="{{ r.filename }}">{{ r.filename }}</div>
                        <div class="text-xs text-gray-500">{{ r.username }}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">
                        {{ (r.size / 1024 / 1024)|round(1) }} MB
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">
                        {{ r.bitrate }} kbps
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <span
                            class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                            {% if r.quality_score > 80 %}bg-green-100 text-green-800{% elif r.quality_score > 0 %}bg-yellow-100 text-yellow-800{% else %}bg-red-100 text-red-800{% endif %}">
                            {{ r.quality_score }}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="download('{{ r.username }}', '{{ r.filename }}')"
                            class="text-blue-400 hover:text-blue-300">Download</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% if results|length > 20 %}
        <div class="p-4 text-center border-t border-gray-700">
            <button onclick="loadMore()" id="load-more-btn" class="text-blue-400 hover:text-blue-300 font-medium">Load
                More Results</button>
        </div>
        {% endif %}
    </div>
</div>

<!-- Duplicate Modal -->
<div id="dup-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-50">
    <div class="bg-gray-800 p-6 rounded-lg max-w-sm w-full border border-red-600">
        <h3 class="text-xl font-bold text-white mb-2">Duplicate Detected</h3>
        <p class="text-gray-300 mb-4">This track (ISRC match) is already in your history.</p>
        <button onclick="document.getElementById('dup-modal').classList.add('hidden')"
            class="w-full bg-gray-600 text-white py-2 rounded">Close</button>
    </div>
</div>

<script>
    function updateCount() {
        const visible = document.querySelectorAll('.result-row:not(.hidden)').length;
        document.getElementById('visible-count').innerText = visible;
    }
    updateCount();

    function loadMore() {
        const hidden = document.querySelectorAll('.result-row.hidden');
        for (let i = 0; i < 20 && i < hidden.length; i++) {
            hidden[i].classList.remove('hidden');
        }
        if (document.querySelectorAll('.result-row.hidden').length === 0) {
            document.getElementById('load-more-btn').style.display = 'none';
        }
        updateCount();
    }

    async function toggleSmartFilter() {
        const res = await fetch('/api/toggle_quality/{{ track_key|urlencode }}', { method: 'POST' });
        if (res.ok) window.location.reload();
    }

    async function deleteTrack() {
        if (!confirm('Delete and Re-Search?')) return;
        const res = await fetch('/track/{{ track_key|urlencode }}/delete', { method: 'POST' });
        if (res.ok) window.location.href = '/';
    }

    async function download(username, filename) {
        try {
            const res = await fetch('/download/{{ track_key|urlencode }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, filename })
            });

            if (res.status === 409) {
                document.getElementById('dup-modal').classList.remove('hidden');
                document.getElementById('dup-modal').classList.add('flex');
                return;
            }

            const data = await res.json();
            if (data.success) alert('Download Started!');
            else alert('Error: ' + data.error);
        } catch (e) {
            alert('Request failed');
        }
    }
</script>
{% endblock %}